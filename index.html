<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Kingdom Simulator - HTML Edition</title>
<style>
  :root {
    --bg: #111317;
    --surface: #191c22;
    --card: #1f2430;
    --text: #e5e7eb;
    --muted: #9aa3af;
    --accent: #4f8cf3;
    --good: #3fb950;
    --warn: #e3b341;
    --danger: #f85149;
    --purple: #a78bfa;
    --shadow: 0 2px 10px rgba(0,0,0,.35);
  }
  [data-theme="light"]{
    --bg:#f6f7f9; --surface:#ffffff; --card:#ffffff; --text:#111827; --muted:#6b7280;
    --accent:#316de6; --good:#22863a; --warn:#c69026; --danger:#e12d39; --purple:#7c5ce0;
    --shadow: 0 2px 10px rgba(0,0,0,.12);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:var(--bg); color:var(--text); font:14px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }
  .header{
    background:var(--surface); display:flex; align-items:center; gap:14px; padding:12px 16px; box-shadow:var(--shadow); position:sticky; top:0; z-index:10;
  }
  .title{font-weight:700; font-size:18px}
  .statline{color:var(--muted)}
  .btn{border:0; padding:8px 12px; border-radius:10px; background:var(--card); color:var(--text); cursor:pointer}
  .btn.accent{background:var(--accent); color:#fff}
  .btn.good{background:var(--good); color:#fff}
  .btn.warn{background:var(--warn); color:#111}
  .btn.danger{background:var(--danger); color:#fff}
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .container{display:grid; grid-template-columns:1fr; grid-auto-rows:minmax(0,1fr); height:calc(100vh - 56px)}
  .stack{position:relative}
  .panel{position:absolute; inset:0; display:none}
  .panel.active{display:block}
  .grid-3{display:grid; grid-template-columns:260px 1fr 300px; gap:8px; padding:8px; height:100%}
  .card{background:var(--card); border-radius:14px; padding:10px; box-shadow:var(--shadow); height:100%; overflow:auto}
  .section-title{font-weight:700; margin:2px 0 8px 0; font-size:13px}
  .actions .btn{width:100%; margin:4px 0}
  .tabs{display:flex; gap:6px; margin-bottom:8px}
  .tab{background:var(--surface); padding:8px 10px; border-radius:10px; cursor:pointer; color:var(--muted)}
  .tab.active{background:var(--accent); color:#fff}
  .log{white-space:pre-wrap; font-family:ui-monospace,Consolas,monospace; background:var(--surface); border-radius:10px; padding:10px; height:100%; overflow:auto}
  .log .good{color:var(--good)}
  .log .warn{color:var(--warn)}
  .log .danger{color:var(--danger)}
  .log .system{color:var(--accent)}
  .log .merchant{color:var(--purple)}
  .log .muted{color:var(--muted)}
  .row{display:flex; justify-content:space-between; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06)}
  .row:last-child{border-bottom:0}
  .kv{display:flex; flex-direction:column}
  .kv .k{color:var(--muted); font-size:12px}
  .kv .v{font-weight:700}
  .pill{display:inline-block; padding:2px 8px; font-size:12px; border-radius:999px; background:var(--surface); color:var(--muted)}
  .merchant-box{background:var(--surface); border-radius:12px; padding:10px}
  .overlay{position:absolute; inset:0; background:rgba(0,0,0,.55); display:none; align-items:center; justify-content:center; z-index:20}
  .overlay.show{display:flex}
  .modal{background:var(--card); border-radius:16px; padding:14px; width:min(950px,92vw); max-height:88vh; overflow:auto; box-shadow:var(--shadow)}
  .cols-2{display:grid; grid-template-columns:1fr 1fr; gap:8px}
  .grid-btns{display:grid; grid-template-columns:repeat(4,1fr); gap:6px}
  .bar{height:16px; background:var(--surface); border-radius:999px; overflow:hidden}
  .bar > span{display:block; height:100%; background:var(--accent)}
  .muted{color:var(--muted)}
  .sep{height:1px; background:rgba(255,255,255,.06); margin:8px 0}
  .spin{width:62px}
  .shop-row{display:grid; grid-template-columns:1fr auto auto auto; gap:8px; align-items:center; padding:6px 0; border-bottom:1px solid rgba(255,255,255,.06)}
  .shop-row:last-child{border-bottom:0}
  input, select{background:var(--surface); color:var(--text); border:1px solid rgba(255,255,255,.12); border-radius:10px; padding:8px}
  .center{display:flex; align-items:center; justify-content:center}
</style>
</head>
<body>
  <header class="header">
    <div class="title">Kingdom Simulator</div>
    <div id="statline" class="statline"></div>
    <div style="margin-left:auto; display:flex; gap:8px">
      <button id="saveBtn" class="btn accent">Save</button>
      <button id="themeBtn" class="btn">Toggle Theme</button>
    </div>
  </header>

  <main class="container">
    <div class="stack">
      <!-- Menu -->
      <section id="menuPanel" class="panel active">
        <div class="center" style="height:100%">
          <div class="modal" style="max-width:720px">
            <h2 class="title">Start</h2>
            <div class="sep"></div>
            <p>Welcome. Name your kingdom and begin, or load your last save.</p>
            <div class="row">
              <label for="kingdomName">Kingdom Name</label>
              <input id="kingdomName" placeholder="Type a name" />
            </div>
            <div style="display:flex; gap:8px; margin-top:10px">
              <button id="startBtn" class="btn accent">New Game</button>
              <button id="loadBtn" class="btn">Load Save</button>
              <button id="clearBtn" class="btn danger">Clear Save</button>
            </div>
            <div class="sep"></div>
            <small class="muted">No pop ups. Everything runs in this page.</small>
          </div>
        </div>
      </section>

      <!-- Main -->
      <section id="mainPanel" class="panel">
        <div class="grid-3">
          <!-- Left: actions -->
          <aside class="card actions">
            <div class="section-title">Actions</div>
            <button class="btn accent" id="sleepBtn">Sleep</button>
            <button class="btn" id="taxBtn">Tax</button>
            <button class="btn" id="payBtn">Pay</button>
            <button class="btn" id="expandBtn">Expand</button>
            <button class="btn" id="fightBtn">Fight</button>
            <button class="btn" id="invBtn">Inventory</button>
            <button class="btn" id="shopBtn">Shop</button>
            <button class="btn" id="polBtn">Policies</button>
            <button class="btn" id="menuBtn">Menu</button>
            <div class="sep"></div>
            <small class="muted">Shortcuts: F2 save, F5 sleep, Ctrl+I inventory, Ctrl+S shop, Ctrl+P policies.</small>
          </aside>

          <!-- Centre: tabs -->
          <section class="card" style="display:flex; flex-direction:column">
            <div class="tabs">
              <div data-tab="log" class="tab active">Log</div>
              <div data-tab="inventory" class="tab">Inventory</div>
              <div data-tab="merchant" class="tab">Merchant</div>
            </div>
            <div id="tab-log" style="flex:1; min-height:0">
              <div id="log" class="log"></div>
            </div>
            <div id="tab-inventory" style="display:none">
              <div class="row"><div class="kv"><div class="k">Health Potion</div><div id="inv-hp" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Mana Potion</div><div id="inv-mp" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Stamina Potion</div><div id="inv-sp" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Damage Potion</div><div id="inv-dp" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Lightning Potion</div><div id="inv-lp" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Sleep Potion</div><div id="inv-slp" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Poison Potion</div><div id="inv-pp" class="v">0</div></div></div>
              <div class="sep"></div>
              <div class="row"><div class="kv"><div class="k">Bread</div><div id="inv-bread" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Meat</div><div id="inv-meat" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Fruit</div><div id="inv-fruit" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Cheese</div><div id="inv-cheese" class="v">0</div></div></div>
              <div class="sep"></div>
              <div class="row"><div class="kv"><div class="k">Weapon</div><div id="inv-weapon" class="v">None</div></div></div>
              <div class="row"><div class="kv"><div class="k">Coins</div><div id="inv-coins" class="v">0</div></div></div>
              <div class="row"><div class="kv"><div class="k">Expansion Cost</div><div id="inv-expand" class="v">0</div></div></div>
            </div>
            <div id="tab-merchant" style="display:none">
              <div class="merchant-box">
                <div id="merchantText" class="muted">No active offer.</div>
                <div style="margin-top:8px; display:flex; gap:8px; justify-content:flex-end">
                  <button id="merchantBuy" class="btn" disabled>Buy</button>
                  <button id="merchantDismiss" class="btn" disabled>Dismiss</button>
                </div>
              </div>
            </div>
          </section>

          <!-- Right: stats -->
          <aside class="card">
            <div class="section-title">Stats</div>
            <div class="row"><div class="kv"><div class="k">Age</div><div id="st-era" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Day</div><div id="st-day" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Money</div><div id="st-money" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Population</div><div id="st-pop" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Happiness</div><div id="st-happy" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Food</div><div id="st-food" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Sword</div><div id="st-sword" class="v"></div></div></div>
            <div class="row"><div class="kv"><div class="k">Strength</div><div id="st-str" class="v"></div></div></div>
          </aside>
        </div>
      </section>
    </div>
  </main>

  <!-- Fight Overlay -->
  <div id="fightOverlay" class="overlay">
    <div class="modal">
      <h3 style="margin:0 0 8px 0">Battle</h3>
      <div class="cols-2">
        <div>
          <div class="muted">Your Health</div>
          <div class="bar"><span id="pbar" style="width:100%"></span></div>
          <div id="ptext" style="margin:4px 0 10px 0">100</div>
          <div class="muted">Enemy Health</div>
          <div class="bar"><span id="ebar" style="width:100%"></span></div>
          <div id="etext" style="margin:4px 0 10px 0">100</div>
          <div class="grid-btns" style="margin-top:8px">
            <button class="btn" data-act="strike">Strike</button>
            <button class="btn" data-act="block">Block</button>
            <button class="btn" data-act="heal">Heal</button>
            <button class="btn" data-act="dmg_pot">Damage Potion</button>
            <button class="btn" data-act="lightning">Lightning</button>
            <button class="btn" data-act="sleep">Sleep</button>
            <button class="btn" data-act="poison">Poison</button>
          </div>
          <div style="text-align:right; margin-top:8px"><button id="fightEnd" class="btn danger">End Battle</button></div>
        </div>
        <div>
          <div class="log" id="fightLog" style="height:310px"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Shop Overlay -->
  <div id="shopOverlay" class="overlay">
    <div class="modal">
      <h3 style="margin:0 0 8px 0">Shop</h3>
      <div class="tabs">
        <div class="tab active" data-shop="potions">Potions</div>
        <div class="tab" data-shop="food">Food</div>
        <div class="tab" data-shop="weapons">Weapons</div>
        <div class="pill" style="margin-left:auto">Wallet: <span id="wallet">0</span></div>
      </div>
      <div id="shop-potions"></div>
      <div id="shop-food" style="display:none"></div>
      <div id="shop-weapons" style="display:none"></div>
      <div style="text-align:right; margin-top:8px">
        <button id="shopClose" class="btn">Close</button>
      </div>
    </div>
  </div>

  <!-- Policies Overlay -->
  <div id="polOverlay" class="overlay">
    <div class="modal">
      <h3 style="margin:0 0 8px 0">Policies</h3>
      <div id="polList"></div>
      <div style="text-align:right; margin-top:8px">
        <button id="polClose" class="btn">Close</button>
      </div>
    </div>
  </div>

<script>
(() => {
  const clamp = (v, lo, hi) => Math.max(lo, Math.min(hi, v));
  const $ = sel => document.querySelector(sel);
  const $$ = sel => Array.from(document.querySelectorAll(sel));
  const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;

  const ERAS = {1:"Stone Age",2:"Bronze Age",3:"Iron Age",4:"Roman Age",5:"Medievil Age",6:"Electric Age",7:"Modern Age"};
  const ERA_SEQ = ["Bronze Age","Iron Age","Roman Age","Medievil Age","Electric Age","Modern Age"];

  const WEAPONS = [
    {id:1,era:1,name:"Pebble",price:1000,damage:2},
    {id:2,era:1,name:"Stone",price:5000,damage:5},
    {id:3,era:1,name:"Rock",price:7500,damage:7},
    {id:4,era:1,name:"Chiselled Stone",price:12000,damage:12},
    {id:5,era:1,name:"Sharpened Rock",price:16000,damage:15},

    {id:1,era:3,name:"Iron Spear",price:165000,damage:34},
    {id:2,era:3,name:"Steel Sword",price:200000,damage:38},
    {id:3,era:3,name:"Lance",price:220000,damage:42},
    {id:4,era:3,name:"Axe",price:235000,damage:46},
    {id:5,era:3,name:"Bow",price:260000,damage:50},

    {id:1,era:5,name:"Socketed Axe",price:30000,damage:17},
    {id:2,era:5,name:"Dagger",price:45000,damage:20},
    {id:3,era:5,name:"Sickle Sword",price:60000,damage:24},
    {id:4,era:5,name:"Reinforced Axe",price:90000,damage:27},
    {id:5,era:5,name:"Dead Oak Bow",price:120000,damage:30},

    {id:1,era:6,name:"Glock",price:1045000,damage:98},
    {id:2,era:6,name:"Uzi",price:1100000,damage:100},
    {id:3,era:6,name:"Maxim Gun",price:1150000,damage:102},
    {id:4,era:6,name:"AK-47",price:1200000,damage:104},
    {id:5,era:6,name:"M1 Garand",price:1300000,damage:106},

    {id:1,era:7,name:"Composite Knife",price:9000,damage:75},
    {id:2,era:7,name:"Smartsteel Katana",price:12000,damage:95},
    {id:3,era:7,name:"Laser Saber",price:20000,damage:120},
  ];

  const POTIONS = [
    {id:1,name:"Health Potion",price:500,var:"hpotion"},
    {id:2,name:"Mana Potion",price:750,var:"mpotion"},
    {id:3,name:"Stamina Potion",price:1000,var:"spotion"},
    {id:4,name:"Damage Potion",price:1500,var:"dpotion"},
    {id:5,name:"Lightning Potion",price:2000,var:"lightning_potion"},
    {id:6,name:"Sleep Potion",price:1800,var:"sleep_potion"},
    {id:7,name:"Poison Potion",price:1700,var:"poison_potion"},
  ];

  const FOOD = [
    {id:1,name:"Bread",price:20,var:"bread"},
    {id:2,name:"Meat",price:50,var:"meat"},
    {id:3,name:"Fruit",price:30,var:"fruit"},
    {id:4,name:"Cheese",price:40,var:"cheese"},
  ];

  const ENEMY = {
    EASY:{health:100,damage_min:2,damage_max:7,coins_min:50,coins_max:150},
    MEDIUM:{health:200,damage_min:7,damage_max:12,coins_min:100,coins_max:500},
    HARD:{health:300,damage_min:10,damage_max:20,coins_min:150,coins_max:800},
  };

  const MERCHANT_BY_ERA = {
    "Stone Age":[
      {name:"Sharpened Bone",bonus:15,price:600,rarity:"Common"},
      {name:"Jagged Flint Axe",bonus:20,price:1200,rarity:"Rare"},
      {name:"Mammoth Fang Blade",bonus:30,price:2000,rarity:"Epic"},
    ],
    "Bronze Age":[
      {name:"Bronze Shortblade",bonus:22,price:1400,rarity:"Common"},
      {name:"Fire-Hardened Spear",bonus:30,price:2400,rarity:"Rare"},
      {name:"Sun-Kissed Dagger",bonus:38,price:3500,rarity:"Epic"},
    ],
    "Iron Age":[
      {name:"Iron Cleaver",bonus:35,price:3000,rarity:"Common"},
      {name:"Spiked Mace",bonus:42,price:4000,rarity:"Rare"},
      {name:"Molten Iron Blade",bonus:52,price:5500,rarity:"Epic"},
    ],
    "Roman Age":[
      {name:"Legionnaire’s Gladius",bonus:40,price:3500,rarity:"Common"},
      {name:"Colosseum Cutter",bonus:50,price:5000,rarity:"Rare"},
      {name:"Centurion’s Edge",bonus:65,price:7500,rarity:"Epic"},
    ],
    "Medievil Age":[
      {name:"Crusader Sword",bonus:50,price:5000,rarity:"Common"},
      {name:"Dragonsteel Falchion",bonus:60,price:7000,rarity:"Rare"},
      {name:"Vampire Slayer",bonus:80,price:10000,rarity:"Epic"},
    ],
    "Electric Age":[
      {name:"Insulated Cutter",bonus:65,price:7000,rarity:"Common"},
      {name:"Arc Blade",bonus:80,price:10000,rarity:"Rare"},
      {name:"Tesla Edge",bonus:100,price:15000,rarity:"Epic"},
    ],
    "Modern Age":[
      {name:"Composite Tactical Knife",bonus:75,price:9000,rarity:"Common"},
      {name:"Smartsteel Katana",bonus:95,price:12000,rarity:"Rare"},
      {name:"Prototype Laser Saber",bonus:120,price:20000,rarity:"Epic"},
    ],
  };

  const state = {
    name:"kingdom name",
    day:1,
    death_day:rand(80,150),
    money:999990,
    exmoney:5000,
    pmoney:0,

    people:50, maxpeople:50, happiness:50,
    phealth:100, maxphealth:100, strength:3, maxstrength:3,
    ehealth:100,

    hpotion:0, dpotion:0, mpotion:0, spotion:0, lightning_potion:0, sleep_potion:0, poison_potion:0,
    bread:10, meat:0, fruit:0, cheese:0,

    currentEra:"Stone Age",
    currentSword:"None",
    minDmg:5, maxDmg:15,
    wfight:0, lfight:0,

    merchant_relationship:0, merchant_weapon_log:{},
    last_merchant_offer_type:null,

    number:-1, // index into ERA_SEQ
    owned_weapon:{1:0,2:0,3:0,4:0,5:0,6:0,7:0},

    policies:{
      "Universal Tax":{locked:true,active:false,desc:"Gain more tax money, but lower happiness."},
      "Charity Relief":{locked:true,active:false,desc:"Lose money per day to boost happiness."},
      "Royal Festival":{locked:true,active:false,desc:"Auto celebrates every 5 days."},
      "Food Rationing":{locked:true,active:false,desc:"Reduce food consumption, reduce happiness."},
      "Open Borders":{locked:true,active:false,desc:"Chance for more migrants, sometimes unrest."},
      "Public Health":{locked:true,active:false,desc:"Reduces sickness, small gold cost daily."},
      "Work Tax Rebate":{locked:true,active:false,desc:"Boost worker morale, costs coins."},
      "Electric Welfare":{locked:true,active:false,desc:"Auto fixes disasters for coin cost. Electric+ only."},
    },

    logs:["","","","",""],

    pendingMerchant:null,
    fight:{cfg:null, stunned:false, poisonTurns:0},
  };

  // UI helpers
  const setTheme = t => document.documentElement.setAttribute("data-theme", t);
  const toggleTheme = () => setTheme(document.documentElement.getAttribute("data-theme")==="light"?"dark":"light");
  const raise = id => {
    $$("#mainPanel, #menuPanel").forEach(n=>n.classList.remove("active"));
    $(id).classList.add("active");
    refresh();
  };
  const openOverlay = el => el.classList.add("show");
  const closeOverlay = el => el.classList.remove("show");

  const logEl = $("#log");
  const appendLog = (text, tag="event") => {
    state.logs = state.logs.slice(1).concat([text]);
    const p = document.createElement("div");
    p.className = tag;
    p.textContent = text;
    logEl.appendChild(p);
    logEl.scrollTop = logEl.scrollHeight;
    trimLog();
  };
  const trimLog = () => {
    while (logEl.childNodes.length > 600) logEl.removeChild(logEl.firstChild);
  };

  // Save and load
  const SAVE_KEY = "kingdom_save_v1";
  const saveGame = () => {
    localStorage.setItem(SAVE_KEY, JSON.stringify(state));
    appendLog("Game saved.", "system");
  };
  const loadGame = () => {
    const raw = localStorage.getItem(SAVE_KEY);
    if(!raw){ appendLog("No save found.", "system"); return false; }
    try{
      const s = JSON.parse(raw);
      Object.assign(state, s);
      appendLog("Game loaded.", "system");
      return true;
    }catch(e){
      appendLog("Failed to load save.", "danger");
      return false;
    }
  };
  const clearSave = () => { localStorage.removeItem(SAVE_KEY); appendLog("Save cleared.", "system"); };

  // Stats render
  function refresh(){
    $("#statline").textContent = `${state.name} | Day ${state.day} | ${state.currentEra} | ${state.money} coins`;
    $("#st-era").textContent = state.currentEra;
    $("#st-day").textContent = state.day;
    $("#st-money").textContent = state.money;
    $("#st-pop").textContent = `${state.people}/${state.maxpeople}`;
    $("#st-happy").textContent = state.happiness;
    $("#st-food").textContent = state.bread;
    $("#st-sword").textContent = state.currentSword;
    $("#st-str").textContent = `${state.strength}/${state.maxstrength}`;

    $("#inv-hp").textContent = state.hpotion;
    $("#inv-mp").textContent = state.mpotion;
    $("#inv-sp").textContent = state.spotion;
    $("#inv-dp").textContent = state.dpotion;
    $("#inv-lp").textContent = state.lightning_potion;
    $("#inv-slp").textContent = state.sleep_potion;
    $("#inv-pp").textContent = state.poison_potion;
    $("#inv-bread").textContent = state.bread;
    $("#inv-meat").textContent = state.meat;
    $("#inv-fruit").textContent = state.fruit;
    $("#inv-cheese").textContent = state.cheese;
    $("#inv-weapon").textContent = state.currentSword;
    $("#inv-coins").textContent = state.money;
    $("#inv-expand").textContent = state.exmoney;

    $("#wallet").textContent = state.money;
  }

  // Tabs
  $$(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      const group = t.parentElement;
      group.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      const id = t.dataset.tab || t.dataset.shop;
      if(t.dataset.tab){
        $("#tab-log").style.display = id==="log"?"block":"none";
        $("#tab-inventory").style.display = id==="inventory"?"block":"none";
        $("#tab-merchant").style.display = id==="merchant"?"block":"none";
      }else{
        $("#shop-potions").style.display = id==="potions"?"block":"none";
        $("#shop-food").style.display = id==="food"?"block":"none";
        $("#shop-weapons").style.display = id==="weapons"?"block":"none";
      }
    });
  });

  // Menu buttons
  $("#startBtn").addEventListener("click", ()=>{
    const nm = $("#kingdomName").value.trim();
    state.name = nm || "kingdom name";
    raise("#mainPanel");
    appendLog(`${state.name}, it is. Use the actions on the left to play.`, "system");
    appendLog("==================================================","muted");
  });
  $("#loadBtn").addEventListener("click", ()=>{
    if(loadGame()){ raise("#mainPanel"); }
  });
  $("#clearBtn").addEventListener("click", clearSave);

  // Header buttons
  $("#saveBtn").addEventListener("click", saveGame);
  $("#themeBtn").addEventListener("click", toggleTheme);

  // Left actions
  $("#sleepBtn").addEventListener("click", ()=>{ command_sleep(); refresh(); });
  $("#taxBtn").addEventListener("click", ()=>{ command_tax(); refresh(); });
  $("#payBtn").addEventListener("click", ()=>{ command_pay(); refresh(); });
  $("#expandBtn").addEventListener("click", ()=>{ command_expand(); refresh(); });
  $("#fightBtn").addEventListener("click", openFightMenu);
  $("#invBtn").addEventListener("click", ()=>selectTab("inventory"));
  $("#shopBtn").addEventListener("click", ()=>openShop());
  $("#polBtn").addEventListener("click", ()=>openPolicies());
  $("#menuBtn").addEventListener("click", ()=>raise("#menuPanel"));

  function selectTab(id){
    document.querySelectorAll('[data-tab]').forEach(t=>t.classList.remove("active"));
    document.querySelector(`[data-tab="${id}"]`).classList.add("active");
    $("#tab-log").style.display = id==="log"?"block":"none";
    $("#tab-inventory").style.display = id==="inventory"?"block":"none";
    $("#tab-merchant").style.display = id==="merchant"?"block":"none";
  }

  // Keyboard shortcuts
  window.addEventListener("keydown", e=>{
    if(e.key==="F2"){ e.preventDefault(); saveGame(); }
    if(e.key==="F5"){ e.preventDefault(); command_sleep(); refresh(); }
    if(e.ctrlKey && (e.key==="i"||e.key==="I")){ e.preventDefault(); selectTab("inventory"); }
    if(e.ctrlKey && (e.key==="s"||e.key==="S")){ e.preventDefault(); openShop(); }
    if(e.ctrlKey && (e.key==="p"||e.key==="P")){ e.preventDefault(); openPolicies(); }
  });

  // Game Commands
  function command_sleep(){
    state.strength = state.maxstrength;
    state.day += 1;
    let required_food = state.people;
    if(state.policies["Food Rationing"].active) required_food = Math.floor(state.people*0.75);
    if(state.bread >= required_food){
      state.bread -= required_food;
      appendLog(`You consumed ${required_food} food for your population.`,"event");
    }else{
      const shortage = required_food - state.bread;
      state.bread = 0;
      const happiness_loss = Math.floor(shortage/2);
      const people_lost = Math.floor(shortage/5);
      state.happiness = clamp(state.happiness - happiness_loss, 0, 100);
      state.people = Math.max(0, state.people - people_lost);
      appendLog(`Food Shortage. Lost ${people_lost} people, happiness -${happiness_loss}.`,"warn");
    }

    const r = rand(1,100);
    if(r<=15){
      const loss = rand(50,200); state.money = Math.max(0, state.money - loss);
      appendLog(`Bandits raided your treasury. Lost ${loss} coins.`,"warn");
    }else if(r<=30){
      const g = rand(5,15); state.happiness = clamp(state.happiness+g,0,100);
      appendLog(`Festival. Happiness +${g}.`,"good");
    }else if(r<=40){
      const p = rand(3,10); state.people = Math.min(state.maxpeople, state.people + p);
      appendLog(`Travellers joined your kingdom. +${p} population.`,"good");
    }

    const flavour = {
      "Stone Age":"Your people are learning to craft stone tools.",
      "Bronze Age":"Metalworking begins to shape the future of your army.",
      "Iron Age":"Blacksmiths forge powerful weapons.",
      "Roman Age":"Infrastructure expands under imperial guidance.",
      "Medievil Age":"Armies are growing and the people whisper of war.",
      "Electric Age":"Inventions surge across your cities.",
      "Modern Age":"Skyscrapers rise as society industrialises."
    };
    if(flavour[state.currentEra]) appendLog(flavour[state.currentEra], "muted");

    if([state.death_day-10, state.death_day-5].includes(state.day)) appendLog("You feel your age catching up to you...","muted");
    if(state.day >= state.death_day){ appendLog("Your time has come. Your kingdom now lives on in legend.","danger"); return; }

    if(state.policies["Universal Tax"].active){
      const bonus = rand(20,50); state.money += bonus; state.happiness = clamp(state.happiness-2,0,100);
      appendLog(`Universal Tax active: +${bonus} coins, -2 happiness.`, "system");
    }
    if(state.policies["Charity Relief"].active){
      const cost=30; if(state.money>=cost){ state.money-=cost; state.happiness = clamp(state.happiness+4,0,100); appendLog("Charity Relief: -30 coins, +4 happiness.","system"); }
    }
    if(state.policies["Royal Festival"].active && state.day%5===0){
      state.happiness = clamp(state.happiness+8,0,100); appendLog("Royal Festival held: +8 happiness.","good");
    }
    if(state.policies["Public Health"].active){
      if(rand(1,100)<=10) appendLog("Public Health prevented a disease outbreak.","good");
      else state.happiness = clamp(state.happiness+1,0,100);
    }
    if(state.policies["Open Borders"].active && rand(1,100)<=15){
      const influx = rand(2,8); state.people += influx; appendLog(`Open Borders: +${influx} migrants joined.`,"good");
    }
    if(state.policies["Electric Welfare"].active && state.currentEra==="Electric Age" && rand(1,100)<=20){
      appendLog("Electric Welfare prevented a disaster.","good");
    }

    random_event();
  }

  function command_tax(){
    if(state.happiness<1){ appendLog("Your people were not happy and left. You became broke.","danger"); state.money=0; return; }
    const delta = rand(1,5);
    state.happiness = clamp(state.happiness-delta,0,100);
    state.money += rand(25,50);
    state.strength = Math.max(0, state.strength-1);
    appendLog(`You taxed the people: happiness -${delta}.`,"warn");
  }

  function command_pay(){
    if(state.people<1){ appendLog(`You have no-one left in ${state.name}. You became broke and unpopular.`,"danger"); state.money=0; return; }
    state.money = Math.max(0, state.money-5);
    state.happiness = clamp(state.happiness+5,0,100);
    state.strength = Math.max(0, state.strength-1);
    appendLog("You paid the people. Happiness +5.","good");
  }

  function command_expand(){
    if(state.number>=6){ appendLog("You are already at the top Age.","muted"); return; }
    if(state.money < state.exmoney){ appendLog(`You need ${state.exmoney - state.money} more coins to expand.`,"muted"); return; }
    state.money -= state.exmoney;
    state.exmoney *= 2;
    state.maxpeople *= 2;
    state.number += 1;
    state.currentEra = ERA_SEQ[state.number] || state.currentEra;
    state.maxstrength = Math.max(state.maxstrength,4);
    state.strength = Math.max(0, state.strength-1);
    appendLog(`You advanced to ${state.currentEra}. Max population is now ${state.maxpeople}.`,"good");
  }

  // Events and Merchant
  function discountedPrice(base){
    const discPct = state.merchant_relationship * 6;
    const disc = Math.floor(base * (discPct/100));
    return {final: base - disc, discPct};
  }

  function random_event(){
    const roll = rand(1,100);
    if(roll<=10){
      state.pmoney += 1;
      state.happiness = clamp(state.happiness - rand(5,15), 0, 100);
      const loss = rand(100,300); state.money = Math.max(0, state.money - loss);
      appendLog(`Protest in the streets. Lost ${loss} coins. Happiness reduced.`, "warn");
    }else if(roll<=20){
      const outcome = rand(1,10);
      if(outcome<=6){ const reward = rand(300,800); state.money += reward; appendLog(`You repelled a rogue faction and looted ${reward} coins.`, "good"); }
      else{ const loss = rand(100,400); state.people = Math.max(0, state.people - rand(3,10)); state.money = Math.max(0, state.money - loss); appendLog(`You lost to a rogue faction. People and ${loss} coins lost.`, "warn"); }
    }else if(roll<=30){
      merchant_event();
    }else if(roll<=40){
      const disaster = Math.random()<.5?"Famine":"Flood";
      if(disaster==="Famine"){
        const lost = rand(5,15); state.people = Math.max(0, state.people - lost); state.bread = Math.max(0, state.bread - lost); state.happiness = clamp(state.happiness-10,0,100); appendLog(`Famine struck. ${lost} people died and food supplies dwindled.`,"warn");
      }else{
        const loss = rand(10,20); state.bread = Math.max(0, state.bread - loss); state.happiness = clamp(state.happiness-5,0,100); appendLog(`Flooding damaged crops. ${loss} bread lost.`,"warn");
      }
    }else if(roll<=50){
      state.happiness = clamp(state.happiness+10,0,100); appendLog("A royal decision pleased the people. Happiness rises.","good");
    }else if(roll<=55){
      if(Math.random()<.5){ state.happiness = clamp(state.happiness-10,0,100); state.money = Math.max(0, state.money-200); appendLog("A cursed relic brought misfortune.","warn"); }
      else { state.happiness = clamp(state.happiness+10,0,100); state.money += 500; appendLog("An enchanted relic blessed the land. +500 coins.","good"); }
    }else if(roll<=60){
      const locked = Object.keys(state.policies).filter(k=>state.policies[k].locked);
      if(locked.length){ const p = locked[Math.floor(Math.random()*locked.length)]; state.policies[p].locked=false; appendLog(`New policy emerged: ${p}. ${state.policies[p].desc}`,"system"); }
    }else if(roll<=70){
      const bonus = rand(10,30); state.happiness = clamp(state.happiness+bonus,0,100); appendLog(`A festival boosted morale. +${bonus} happiness.`,"good");
    }else if(roll<=80){
      const coins = rand(200,600); state.money += coins; appendLog(`Buried treasure found. +${coins} coins.`,"good");
    }else{
      appendLog("A calm day passes.","muted");
    }
  }

  function merchant_event(){
    let offerType = "unique";
    if(state.currentEra in MERCHANT_BY_ERA && !(state.currentEra in state.merchant_weapon_log)){
      if(rand(1,100)<=3 && state.last_merchant_offer_type!=="weapon") offerType = "weapon";
    }
    if(offerType === state.last_merchant_offer_type) offerType = "unique";

    if(offerType==="weapon"){
      const pool = MERCHANT_BY_ERA[state.currentEra];
      const weighted = [];
      for(const w of pool){ const n = w.rarity==="Common"?3: w.rarity==="Rare"?2:1; for(let i=0;i<n;i++) weighted.push(w); }
      const sel = weighted[Math.floor(Math.random()*weighted.length)];
      const {final,discPct} = discountedPrice(sel.price);
      appendLog(`Merchant offers a ${sel.rarity} weapon: ${sel.name} (+${sel.bonus} DMG). Price ${final} coins (${discPct}% off).`,"merchant");
      showMerchantOffer({kind:"weapon", name:sel.name, bonus:sel.bonus, price:final});
      state.last_merchant_offer_type="weapon";
    }else{
      const rare = [
        {name:"Golden Cheese", effect:"happiness", value:5, price:700},
        {name:"Ancient Scroll", effect:"maxstrength", value:1, price:1000},
        {name:"Map Fragment", effect:null, value:0, price:800}
      ].filter(x=>x.name!==state.last_merchant_offer_type);
      const sel = rare[Math.floor(Math.random()*rare.length)];
      const {final} = discountedPrice(sel.price);
      appendLog(`Merchant offers ${sel.name}. Price ${final} coins.`,"merchant");
      showMerchantOffer({kind:"unique", name:sel.name, effect:sel.effect, value:sel.value, price:final});
      state.last_merchant_offer_type=sel.name;
    }
  }

  function showMerchantOffer(payload){
    state.pendingMerchant = payload;
    $("#merchantText").textContent =
      payload.kind==="weapon"
        ? `${payload.name} (+${payload.bonus} DMG) for ${payload.price} coins`
        : payload.effect==="happiness" ? `${payload.name} (+5 happiness) for ${payload.price} coins`
        : payload.effect==="maxstrength" ? `${payload.name} (+1 max strength) for ${payload.price} coins`
        : `${payload.name} (collectible) for ${payload.price} coins`;
    $("#merchantBuy").disabled = false;
    $("#merchantDismiss").disabled = false;
    selectTab("merchant");
  }
  $("#merchantBuy").addEventListener("click", ()=>{
    const p = state.pendingMerchant; if(!p) return;
    if(state.money < p.price){ appendLog("You cannot afford it.","warn"); return; }
    state.money -= p.price;
    if(p.kind==="weapon"){
      state.minDmg = 5 + p.bonus; state.maxDmg = 15 + p.bonus; state.currentSword = `${p.name} (+${p.bonus} DMG)`;
      state.merchant_weapon_log[state.currentEra]=true;
      state.merchant_relationship = Math.min(5, state.merchant_relationship+1);
      appendLog(`You purchased ${p.name}.`,"merchant");
    }else{
      if(p.effect==="happiness") state.happiness = clamp(state.happiness+5,0,100);
      if(p.effect==="maxstrength") state.maxstrength += 1;
      state.merchant_relationship = Math.min(5, state.merchant_relationship+1);
      appendLog(`You bought ${p.name}.`,"merchant");
    }
    $("#merchantText").textContent = "No active offer.";
    $("#merchantBuy").disabled = true;
    $("#merchantDismiss").disabled = true;
    state.pendingMerchant = null;
    refresh();
  });
  $("#merchantDismiss").addEventListener("click", ()=>{
    $("#merchantText").textContent = "No active offer.";
    $("#merchantBuy").disabled = true;
    $("#merchantDismiss").disabled = true;
    state.pendingMerchant = null;
  });

  // Fight
  function openFightMenu(){
    // Simple inline difficulty selector in the log
    appendLog("Choose difficulty: [Easy] [Medium] [Hard]","system");
    // Bind temporary click handlers on log
    const opts = [
      {text:"Easy", key:"EASY"},
      {text:"Medium", key:"MEDIUM"},
      {text:"Hard", key:"HARD"},
    ];
    const line = document.createElement("div");
    opts.forEach(o=>{
      const b = document.createElement("button");
      b.textContent = o.text; b.className = "btn"; b.style.marginRight="6px";
      b.onclick = ()=>{ line.remove(); start_fight(o.key); };
      line.appendChild(b);
    });
    logEl.appendChild(line);
    logEl.scrollTop = logEl.scrollHeight;
  }

  function start_fight(diffKey){
    state.ehealth = ENEMY[diffKey].health;
    state.phealth = 100;
    state.fight = {cfg:ENEMY[diffKey], stunned:false, poisonTurns:0};
    $("#fightLog").textContent="";
    updateFightBars();
    openOverlay($("#fightOverlay"));
  }

  function fightPush(txt){
    const p = document.createElement("div");
    p.textContent = txt;
    $("#fightLog").appendChild(p);
    $("#fightLog").scrollTop = $("#fightLog").scrollHeight;
  }

  function updateFightBars(){
    $("#ptext").textContent = state.phealth;
    $("#etext").textContent = state.ehealth;
    $("#pbar").style.width = `${state.phealth}%`;
    const emax = Math.max(state.fight.cfg.health, 1);
    $("#ebar").style.width = `${100*state.ehealth/emax}%`;
    if(state.fight.poisonTurns>0 && state.ehealth>0){
      state.ehealth = Math.max(0, state.ehealth - 5);
      state.fight.poisonTurns -= 1;
      fightPush("Poison deals 5 damage to the enemy.");
      $("#etext").textContent = state.ehealth;
      $("#ebar").style.width = `${100*state.ehealth/emax}%`;
    }
  }

  $$("#fightOverlay [data-act]").forEach(btn=>{
    btn.addEventListener("click", ()=>player_action(btn.dataset.act));
  });
  $("#fightEnd").addEventListener("click", ()=>closeOverlay($("#fightOverlay")));

  function player_action(action){
    let stunnedNow = false;
    let pdamage = 0;
    if(action==="strike"){
      pdamage = rand(state.minDmg, state.maxDmg);
      fightPush(`You struck the enemy for ${pdamage} damage.`);
    }else if(action==="block"){
      const blk = rand(10,30); pdamage = -blk; fightPush(`You prepare to block ${blk} damage.`);
    }else if(action==="heal"){
      if(state.hpotion>0){ state.phealth = 100; state.hpotion -= 1; fightPush("You healed to full health."); }
      else fightPush("No Health potions left.");
      updateFightBars(); refresh(); return;
    }else if(action==="dmg_pot"){
      if(state.dpotion>0){ const bonus=10; state.dpotion -= 1; pdamage = rand(state.minDmg,state.maxDmg)+bonus; fightPush(`Damage Potion used. +${bonus} bonus. You hit for ${pdamage} damage.`);}
      else { fightPush("No Damage potions left."); return; }
    }else if(action==="lightning"){
      if(state.lightning_potion>0){ state.lightning_potion -= 1; stunnedNow = true; fightPush("Lightning potion used. Enemy is stunned next turn."); }
      else fightPush("No Lightning potions left.");
      updateFightBars(); refresh(); return;
    }else if(action==="sleep"){
      if(state.sleep_potion>0){ state.sleep_potion -= 1; stunnedNow = true; fightPush("Sleep potion used. Enemy sleeps for one turn."); }
      else fightPush("No Sleep potions left.");
      updateFightBars(); refresh(); return;
    }else if(action==="poison"){
      if(state.poison_potion>0){ state.poison_potion -= 1; state.fight.poisonTurns = 3; fightPush("Poison applied. Enemy will take damage over 3 turns."); }
      else fightPush("No Poison potions left.");
      updateFightBars(); refresh(); return;
    }

    if(pdamage>=0){ state.ehealth = Math.max(0, state.ehealth - pdamage); }
    if(state.fight.stunned){ fightPush("Enemy is stunned and skips its turn."); state.fight.stunned = false; }
    else{
      let edmg = rand(state.fight.cfg.damage_min, state.fight.cfg.damage_max);
      if(pdamage<0) edmg = Math.max(0, edmg + pdamage);
      state.phealth = Math.max(0, state.phealth - edmg);
      fightPush(`Enemy attacks and deals ${edmg} damage.`);
    }
    if(stunnedNow) state.fight.stunned = true;
    updateFightBars(); refresh();

    if(state.ehealth<=0 || state.phealth<=0){
      if(state.ehealth<=0){
        const reward = rand(state.fight.cfg.coins_min, state.fight.cfg.coins_max);
        state.money += reward; state.wfight += 1; fightPush(`You defeated the enemy. Earned ${reward} coins.`);
      }else{
        state.lfight += 1; fightPush("You were defeated. Retreating to your kingdom.");
      }
    }
  }

  // Shop
  function openShop(){
    buildShop();
    openOverlay($("#shopOverlay"));
  }
  $("#shopClose").addEventListener("click", ()=>closeOverlay($("#shopOverlay")));

  function buildShop(){
    $("#wallet").textContent = state.money;

    const potRoot = $("#shop-potions"); potRoot.innerHTML = "";
    POTIONS.forEach(it=>{
      const row = document.createElement("div"); row.className="shop-row";
      row.innerHTML = `<div>${it.name}</div><div class="muted">${it.price} coins</div>`;
      const spin = document.createElement("input"); spin.type="number"; spin.min=1; spin.value=1; spin.className="spin";
      const btn = document.createElement("button"); btn.className="btn"; btn.textContent="Buy";
      btn.onclick = ()=>buyStack(it.var, it.price, parseInt(spin.value||"1"), it.name);
      row.appendChild(spin); row.appendChild(btn); potRoot.appendChild(row);
    });

    const foodRoot = $("#shop-food"); foodRoot.innerHTML = "";
    FOOD.forEach(it=>{
      const row = document.createElement("div"); row.className="shop-row";
      row.innerHTML = `<div>${it.name}</div><div class="muted">${it.price} coins</div>`;
      const spin = document.createElement("input"); spin.type="number"; spin.min=1; spin.value=1; spin.className="spin";
      const btn = document.createElement("button"); btn.className="btn"; btn.textContent="Buy";
      btn.onclick = ()=>buyStack(it.var, it.price, parseInt(spin.value||"1"), it.name);
      row.appendChild(spin); row.appendChild(btn); foodRoot.appendChild(row);
    });

    const weapRoot = $("#shop-weapons"); weapRoot.innerHTML="";
    Object.keys(ERAS).map(Number).sort((a,b)=>a-b).forEach(eraId=>{
      const eraName = ERAS[eraId];
      const h = document.createElement("div"); h.className="section-title"; h.textContent = eraName; weapRoot.appendChild(h);
      WEAPONS.filter(w=>w.era===eraId).forEach(w=>{
        const locked = w.id <= (state.owned_weapon[eraId]||0);
        const row = document.createElement("div"); row.className="shop-row";
        row.innerHTML = `<div>[${w.id}] ${w.name} +${w.damage} DMG</div><div class="muted">${locked?"LOCKED":`${w.price} coins`}</div>`;
        const spacer = document.createElement("div"); spacer.textContent="";
        const btn = document.createElement("button"); btn.className="btn"; btn.textContent="Buy"; btn.disabled = locked;
        btn.onclick = ()=>buyWeapon(eraId, w.id);
        row.appendChild(spacer); row.appendChild(btn); weapRoot.appendChild(row);
      });
    });
  }

  function buyStack(varname, price, qty, name){
    if(qty<=0) return;
    const total = price*qty;
    if(state.money<total){ appendLog("Not enough coins.","warn"); return; }
    state.money -= total;
    state[varname] = (state[varname]||0) + qty;
    appendLog(`Purchased ${qty} ${name}.`,"good");
    refresh(); buildShop();
  }

  function buyWeapon(eraId, wid){
    const w = WEAPONS.find(x=>x.era===eraId && x.id===wid); if(!w) return;
    if(wid <= (state.owned_weapon[eraId]||0)){ appendLog("That weapon is locked.","muted"); return; }
    if(state.money < w.price){ appendLog("Not enough coins.","warn"); return; }
    state.money -= w.price;
    state.owned_weapon[eraId] = wid;
    const bonus = w.damage;
    state.minDmg = 5 + bonus; state.maxDmg = 15 + bonus;
    state.currentSword = `${w.name} (+${bonus} DMG)`;
    appendLog(`Purchased ${w.name}.`,"good");
    refresh(); buildShop();
  }

  // Policies
  function openPolicies(){
    const root = $("#polList"); root.innerHTML="";
    Object.entries(state.policies).forEach(([name,data])=>{
      const row = document.createElement("div"); row.className="row";
      const left = document.createElement("div");
      left.innerHTML = `<div><strong>${name}</strong> ${data.locked?'<span class="pill">Locked</span>':data.active?'<span class="pill">Active</span>':'<span class="pill">Inactive</span>'}</div><div class="muted">${data.desc}</div>`;
      const btn = document.createElement("button"); btn.className="btn"; btn.textContent = data.locked? "Locked" : data.active? "Disable" : "Enable";
      btn.disabled = data.locked;
      btn.onclick = ()=>{ data.active = !data.active; openPolicies(); appendLog(`${name} is now ${data.active?'ENABLED':'DISABLED'}.`,"system"); };
      row.appendChild(left); row.appendChild(btn); root.appendChild(row);
    });
    openOverlay($("#polOverlay"));
  }
  $("#polClose").addEventListener("click", ()=>closeOverlay($("#polOverlay")));

  // Start defaults
  setTheme("dark");
  refresh();
})();
</script>
</body>
</html>
